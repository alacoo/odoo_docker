version: '3.7'
services:
  odoo:
    # 1. الصورة المبنية محلياً لـ Odoo 18
    image: new_odoo_18_dockerfile:latest 
    restart: unless-stopped
    command: ["odoo", "--addons-path=/mnt/extra-addons"]
    # ملاحظة: تركنا سطر 'user:' محذوفاً بناءً على رغبتك لاختبار Entrypoint الافتراضي
    # في حال ظهور خطأ "Not Writable"، سنقوم بإضافة user: "1000:1000" لاحقاً.
    
    ports:
      # 2. ربط المنفذ الخارجي 8070 بالمنفذ الداخلي 8069
      - "192.168.88.106:8070:8069" 
      - "192.168.88.244:80:8069" 
      
    environment:
      # 3. تحديد مسارات الإضافات ليقرأها نظام Odoo
      - ODOO_ADDONS_PATH=/mnt/extra-addons
      - ODOO_HTTP_PORT=8069 
      
      # 4. بيانات الاتصال بقاعدة البيانات الخارجية (PostgreSQL)
      - HOST=192.168.88.106
      - USER=admin
      - PASSWORD=222WXJPybFZ3M1Ywd6Ciu9r4ITN222 
      - ODOO_DB_NAME=odoodb
      
      # 5. إعدادات التصحيح والتشغيل (Debug Mode)
      - ODOO_DEBUG_MODE=True       
      - ODOO_DEBUG=True
      - ODOO_DEV_MODE=True
      - ODOO_CORS_ORIGINS=*
      - ODOO_HTTP_CORS=*
      - ODOO_SERVER_WIDE_MODULES=base,web,rest_api_addon
      - ODOO_PROXY_MODE=True
      - ODOO_HTTP_ENABLE=True
      - ODOO_RC=/etc/odoo/odoo.conf
      
      # 6. إعدادات السجلات (Logging) لتسهيل تتبع الأخطاء
      - ODOO_LOG_LEVEL=debug
      - ODOO_LOG_HANDLER=:DEBUG
      - ODOO_LOG_DB=True
      - ODOO_LOG_DB_LEVEL=debug
      - ODOO_LOG_FILE=/var/log/odoo/odoo.log

    volumes:
      # 7. ربط المجلدات المجهزة في TrueNAS (New_Odoo_Data)
      - /mnt/Pool10T/Odoo_Data/web-data:/var/lib/odoo
      - /mnt/Pool10T/Odoo_Data/addons:/mnt/extra-addons
      - /mnt/Pool10T/Odoo_Data/config:/etc/odoo
      - /mnt/Pool10T/Odoo_Data/logs:/var/log/odoo
      
    healthcheck:
      # 8. فحص جاهزية الخدمة داخلياً
      test: ["CMD", "curl", "-f", "http://127.0.0.1:8069"]
      interval: 30s
      timeout: 5s
      retries: 5